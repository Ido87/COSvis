---
title: "Ojective Functions"
author: 
- "Daniel Klotz, Johannes Wesemann, Mathew Herrnegger"
date: "14 Juli 2016"
output:
  html_document:
    number_sections: yes
---

```{r setup, include=FALSE, purl=FALSE}
  knitr::opts_chunk$set(eval = FALSE, tidy = FALSE)
```


# Introduciton
This chapter defines the objective functions that are used in **visCOS**.

Objective functions, in short $of$, are an important part of the hydrological 
model calibration. Their importance arises from the approximate nature of the 
models and the large uncertainties of the process. Hydrological models are not 
only imperfect, in the sense that they simplify nature, but in most cases 
structurally different than the reality so that different models or their 
respective parametrisations approximate the hydrograph equally well. Thus, 
over the time a pletora of objective fucntions have been developed to either 
make the model-results better interpretable/comparable or to adress specific 
problems of given objective functions. 

# Objective Functions 
This section defines the code for different objective functions. If possible the
calculation is done with the help of the `hydroGOF` package, if not an R-code
solution is tried. 
Currently 4 main objective functions are provided in **visCOS**. They can
be directly extracted from the `cos_data` data.frame via the 
[`main_of_`](LP-main_of.html) functions. Other objective functions are provided 
to, but no special extraction and visualisation functions are provided for them. 

For the explanation and definition of the objective fucntion it is assumed that 
 $o$ are the observations (defined by `name_o` in visCOS) and $s$ are the 
 simulation(defined by `name_s` in visCOS).
```{r}
#' Objective Functions
#' 
#' Different objective Functions, provided by visCOS. A detailed description 
#' of each of the provided objective function is provided in the respective
#' vignette
#' 
#' @param o The reference data or observations (o_data)
#' @param s The created data or the simulations (s_data)
#' @name of_overview
NULL
```

## Main Objective Functions
Currently the main objective functions are the Nash-Sutcliffe Efficiency, 
the Kling-Gupta Efficiency, the percentage bias and the correlation.

### Nash-Sutcliffe Efficiency
The Nash-Sutcliffe Criterion $NSE$ is by far the most used efficiency criterion
in hydrology. In the hydrological context $o$ usually represents a set of
runoff-observation and $s$ a set of simulations. The $NSE$ is defined in the
same way as the general definition of the coefficient of determination $R^2$:

$$ NSE = \frac{\sum_{t=1}^T \big( o(t)-s(t) \big)^2}
              {\sum_{t=1}^T \big( o(t)-\bar{o} \big)^2} . $$

The variable $\bar{o}$ represents the average of $o$. The $NSE$
can be seen as the relational the estimator $s$ and the estimator
resulting form the average of the data. It can can have values between minus 
infinity and 1 with 1 being the perfect fit, 0 when the mean of $s$ is as 
good as the mean of $o$ and negative values are even worse.

The code for the $NSE$ computation is:

```{r}
#' Nash-Sutcliffe Efficiency
#' 
#' @rdname of_overview
#' @import hydroGOF
#' @export
of_nse <- function(o,s) {
  as.numeric( NSE(s,o) )
}
```


### Kling-Gupta Efficiency
The Kling-Gupta Efficiency $KGE$ was introduced by Gupta et al. (2009) to
alleviate some of the shortcomings of the $NSE$. In their paper they argue
why the $NSE$ tends to overate simulations with small variance
(note: in the context of the paper $\textrm{simulations} = s$) and
propose their efficiency criterion instead.

The $KGE$ is defined as:

$$ KGE = 1 - ED, $$

with

$$ ED = \sqrt{\big(corr(o,s)-1 \big)^2 +
              \big(\alpha(o,s)-1 \big)^2 +
              \big(\beta(o,s)-1 \big)^2 }. $$

In which $\alpha(o,s) = \frac{\sigma_s}{ \sigma_o }$ is the standard deviation
$\sigma$ of $s$ divided by the $\sigma$  of $o$, $\beta(o,s) = \mu_s / \mu_o$ 
with$\mu$ being the arithmetic mean and $corr(o,s)$ as the 
Pearson's correlation coefficient (see below). The value range and the 
quality is similar to the $NSE$. 

The code for the $KGE$ computation is:
```{r}
#' Kling-Gupta Efficiency
#' 
#' @rdname of_overview
#' @import hydroGOF
#' @export
of_kge <- function(o,s) {
  as.numeric( KGE(s,o) )
}
```

### Percentage Bias
The percentage of bias $pBIAS$ is defined as the sum of the differences
between $o$ and $s$ divided by the sum of $o$:

$$pBIAS = 100*\frac{\sum_{t=1}^T [ o(t)-s(t) ] }{\sum_{t=1}^T o(t)}.$$

The $100*$ is just a scaling factor applied to express $pBIAS$ as a percentage.

The code for the $pBIAS$ computation is:
```{r}
#' Percentage Bias 
#' 
#' @rdname of_overview
#' @import hydroGOF
#' @export
of_pbias <- function(o,s) {
  as.numeric( pbias(s,o) )
}
```

### Pearson's correlation coefficient
Pearson's correlation coefficient, $r$ or $corr(o,s)$, is a measure of the 
linear relationship between $o$ and $s$. It is defined as:

$$r \equiv corr(o,s) = \frac{cov(o,s)}{\sigma_s*\sigma_o},$$

where $cov(...)$ denotes the covariance. The correlation
coefficient can take on values between -1 and 1. The former corresponds to an
inverse and the latter to a direct relationship and the closer the values
is to zero the weaker is the implied correlation. 

The code for the correlation is:
```{r}
#' Correlation
#' 
#' @rdname of_overview
#' @import hydroGOF
#' @export
of_cor <- function(o,s) {
  diag( cor(o,s) )
}
```

## Ohter Objective Functions 

Description shall follow

```{r}
#' Root Mean Sqaured Error 
#' 
#' @rdname of_overview
#' @import hydroGOF
#' @export
of_rmse <- function(o,s) {
  as.numeric( rmse(s,o) )
}
```

```{r}
#' Inverted Nash-Sutcliffe Efficiency
#' 
#' @rdname of_overview
#' @import hydroGOF
#' @export
of_invert_nse <- function(o,s) {
  as.numeric( NSE(o,s) )
}
```

```{r}
#' Ratio of Standard Deviations
#'
#' @rdname of_overview
#' @import hydroGOF
#' @export
of_rsd <- function(o,s) {
  as.numeric( rSD(s,o) )
}
```

```{r}
#' Ratio of Means
#'
#' @rdname of_overview
#' @export
of_rmeans <- function(o,s) {
  as.numeric( mean(s)/mean(o) )
}
```

```{r}
#' Volumetric Efficiency
#'
#' @rdname of_overview
#' @import hydroGOF
#' @export
of_ve <- function(o,s) {
  as.numeric( VE(s,o) )
}
```
