---
title: "Examples for using visCOS"
author: "Daniel Klotz"
date: "6 Juli 2016"
output:
  html_document:
    number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

In this chapter examples for **visCOS**-functions are given that deal with the 
process of transforming  *raw data* into prepared data for **visCOS**.
The data is then *cooked* and can be used for figures etc.

The following steps can be performed:

* Loading of raw data (always necessary if data is not loaded yet)
* Setting visCOS_options (if it doesn't fit your data)
* Remove junk and prepare date format 
* Define and Mark periods

# Loading raw data
From the point of view of **visCOS** raw-data are time-series of observations
and model output. Usually raw data is saved in some simple file format,
e.g. *.txt* or *.csv*. `R` already includes many option to read those files
with the `read.table` functionalities.
For larger unstructured files the read options of the `data.table` package is 
recommended. In our tests it was fastest and most flexible option.
Alternatively the `readr` can be used if the data is more structured and large.

**Note** at this stage, only a comparison between **numbered catchments** 
 for two parameters is possible. So the data must include an integer 
number after the description (like "QObs_001" and "QSim_001").

The function `get_runoff_example` can be used to get some exemplary data
from within **visCOS**:
```{r, message=3:5}
  library(visCOS)
  require(magrittr)
  options(width=80)
  runoff_example_raw <- get_runoff_example()
  head(runoff_example_raw)
```

# Prepare the raw data
## Adapt `viscos_options`
The next step would be to adapt the first part of the `viscos_options`. This 
can be done by copying the default settings from the help and adapt them. In 
this case they are already correct:

```{r}
   viscos_options(
   # data.frame column names
      name_data1 = "qobs",
      name_data2 = "qsim",
      name_COSyear = "yyyy",
      name_COSmonth = "mm",
      name_COSday = "dd",
      name_COShour = "hh",
      name_COSmin = "min",
      name_COSposix = "posixdate",
      name_COSperiod = "period")
```
## Remove junk and prepare date format
Now all the junk data (data columns not needed, unobserved basins) can be 
removed using the `remove_chunk` function. Additionally, leading zeros in the 
column names can be deleted with `remove_leading_zeros` if necessary.

In order to properly analyse the data with **visCOS**, the timesteps must be 
complete and in the right format. This can be done with `prepare_complete_date`. 
Within the data.frame the user has to provide either 5 columns with the 
*COSdate* format: `yyyy-mm-dd-hh-min` i.e.: year-month-day-hour-minute or an 
equivalent column in `POSIXct` format (see: [link](https://stat.ethz.ch/R-manual/R-devel/library/base/html/as.POSIXlt.html))
 to do so.
```{r}
  runoff_example <- remove_chunk(runoff_example_raw) %>% 
  prepare_complete_date()
head(runoff_example)
```
## Define and Mark periods
If a seasonal or periodical analysis of the data wants to be done, these periods 
can be defined with the `mark_periods` function. In the example case, the 
hydrological years, going from September till August, will be defined:
```{r}
  runoff_example <- mark_periods(runoff_example, start_month = 9, end_month = 8)
# here is an example plot to visualise the periods
  plot(runoff_example$period, xlab="Timestep", ylab="# of hydrological year")
```

Note that the example data starts with beginning of September, so right with 
the first hydrological year. The end of the year 2010 is not completely inside 
a hydrological year, so the period counter jumps to one.

# Explore Data and Objective Functions for Subbasins
In this chapter it is shown, how the function `explore_basins_with_of` can be 
used to take a closer look at the data series you loaded. Only prerequirements 
are properly loaded data and correctly addressed `viscos_options`. Additionally, 
you can adapt the *color_data* options in the `viscos_options`. Information on 
the *objective functions* can be found [here](ex-OF_explanation.html)

Running the `explore_basins_with_of` with your data as input, a shiny app is 
started in a new window (in this case an example .jpg with explanations):

```{r, eval = FALSE}
viscos_options(color_data1 = "green", color_data2 = "red")
explore_runoff_with_of(runoff_example)
```
![](figures/eg_explore_basin.JPG)


The program is calculating and displaying the results always on the fly. So by 
changing the basin or the timeframe, the displayed data series and the results 
of the objective functions are adapting. By going with your pointer over the 
data series, the values of the data series at the marked point are displayed in 
the upper right corner.

# Calculate Objective Functions for Subbasins and Periods
In Chapter 3, the objective functions $of$ have been introduced already for the 
interactive analysis of the time series. To get the $of$ values for the periods 
defined with `mark_periods()` and as a summary over the whole timespan, the 
function `extract_objective_functions` can be applied to the prepared data 
series and the results are displayed in the console or can be assigned to a 
variable
```{r, message=3}
of_values <- extract_objective_functions(runoff_example)
of_values
```


