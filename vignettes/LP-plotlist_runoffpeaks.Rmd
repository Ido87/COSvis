---
title: "Runoff Peaks Plots"
author: 
- "Daniel Klotz, Johannes Wesemann"
date: "22 September 2016"
output:
  html_document:
    number_sections: yes
---

```{r setup, include=FALSE, purl=FALSE}
  knitr::opts_chunk$set(eval = FALSE, tidy = FALSE, fig.align = 'center')
```

# Introduction
The fucntion `plotlist_runoffpeaks` lets users explore the highest events in 
among the available basins. It provides a list of [ggplot2](http://ggplot2.org/) 
plots, containing an overview plot (`overview`), a scatter plot (`scatter`) 
and detail plots of the individual events (`event_plot`). Instead of 
explaining the properties of each plot in detail it is best to get an intuition 
of the function by looking at some examples. 

The function takes tree arguments: 

argument | explenation 
-------- | ------------
runoff_data | `data.frame` as used within visCOS
n_events | number of events to be searched 
window_size | Extension of individual events 

## Examples:
For the examples 10 events are extracted from a runoff example
```{r, eval = TRUE, purl=FALSE}
  require(visCOS)
  runoff_data <- get_runoff_example()
  peakplots <- plotlist_runoffpeaks(runoff_data, n_events = 10L)
```

The `peakplots` list does now contain plots for each basin within the 
`runoff_data` data.frame: 
```{r, eval = TRUE, purl=FALSE}
  names(peakplots)
```

For each basin the a set of plots (`overview`,`scatter`,`event_plot`) are saved 
within a list for each basin. In the following the plots for basin 1 are shown:
```{r, eval = TRUE, purl=FALSE}
  names(peakplots$basin0001)
```

The `overview` plot shows the entire time series of `data1` and `data2` of the 
basin. The found events are marked with black dots. The `overview` plot for 
basin 1 is:
```{r, eval = TRUE, purl=FALSE}
  peakplots$basin0001$overview
```

The `scatter` plot shows the found events within a scatter plot, where  `data1` 
is the x-axis and `data2` on the y-axis. In the followin an example for basin 1
is given.
```{r, eval = TRUE, purl=FALSE}
  peakplots$basin0001$scatter
```

Detail plots for each of the found events are given in form of the `event_plot`
objects. Here an example:
```{r, eval = TRUE, purl=FALSE}
  peakplots$basin0001$event_plot5
```


# Code
```{r}
#' Plot List for Runoff Peaks 
#' @export
#' 
#' @import ggplot2 
#' @import dplyr 
#' @import magrittr
#' @importFrom tibble tibble
plotlist_runoffpeaks <- function(runoff_data,
                                 n_events= 10L,
                                 window_size = 24L) {
  # pre:
  assert_dataframe(runoff_data)
  n_events_int <- as.integer(n_events) 
  window_size_int <- as.integer(window_size)
  if( is.na(n_events_int)  | 
      is.nan(n_events_int) | 
      is.infinite(n_events_int) | 
      !is.integer(n_events_int) ) {
    stop("n_events is ill defined")
  }
  if( is.na(window_size)  | 
      is.nan(window_size) | 
      is.infinite(window_size) | 
      !is.integer(window_size) ) {
    stop("window_size is ill defined")
  }
  data1 <- runoff_data %>%
     select( starts_with(viscos_options("name_data1")) )
  data2 <- runoff_data %>%
     select( starts_with(viscos_options("name_data2")) )
  data_numbers <- names(data1) %>%
    gsub(viscos_options("name_data1"),"",.,ignore.case = TRUE) %>% 
    gsub("\\D","",.,ignore.case = TRUE)
  # make plotlist: 
  plotlist <- lapply(1:ncol(data1), function(x) plotlist_one_basin(data1[,x],
                                                                   data2[,x],
                                                                   n_events_int, 
                                                                   window_size_int)) %>%
    set_names(.,paste("basin", data_numbers, sep =""))
  return(plotlist)
}
```


```{r}
plotlist_one_basin <- function(qobs,qsim,n_events_int,window_size_int) {
   #### calc:
  single_data <- tibble::tibble(time = as.integer(1:length(qobs)),
                                obs = as.double(qobs),
                                sim = as.double(qsim))
  #
  peak_idx <- find_peaks(single_data$obs,m = window_size_int)
  peak_organised <- tibble::tibble(idx = as.integer(peak_idx), 
                           peak_obs = single_data$obs[peak_idx], 
                           peak_sim = single_data$sim[peak_idx])
  highest_peaks_organised <- peak_organised$peak_obs %>% 
    sort(decreasing = TRUE) %>% 
    .[1:n_events_int] %>%
    '%in%'(peak_organised$peak_obs,.) %>% 
    which( . ) %>% 
    peak_organised[., ]
  #
  overview_plot <- ggplot() +
    geom_line(data = single_data,aes(x = time, y = sim), col = viscos_options("color_data2")) + 
    geom_line(data = single_data,aes(x = time, y = obs), col = viscos_options("color_data1")) + 
    geom_point(data = highest_peaks_organised, aes(idx, peak_obs))
  overview_scatter <- ggplot() + 
    geom_point(data = single_data, aes(obs,sim), color = "#DDDDDD") +
    geom_abline(color = viscos_options("color_of_mid")) +
    geom_point(data = highest_peaks_organised, aes(peak_obs,peak_sim), size = 4) +
    expand_limits(x = 0, y = 0) 
  sub_plots <- lapply(1:nrow(highest_peaks_organised),
                      function(x) sub_peakplot_fun(x,window_size_int,highest_peaks_organised,single_data) ) %>%
    set_names(.,paste("event_plot",1:length(.),sep=""))
  return(overview = append(list(overview = overview_plot,scatter = overview_scatter), sub_plots))
}
```

## Function to find peaks
Propsoed by http://stats.stackexchange.com/questions/22974/how-to-find-local-peaks-valleys-in-a-series-of-data

btw. also a nice idea: http://stats.stackexchange.com/questions/36309/how-do-i-find-peaks-in-a-dataset
```{r}
  ####
  find_peaks <- function (x, m = 3){
    shape <- diff(sign(diff(x, na.pad = FALSE)))
    pks <- sapply(which(shape < 0), FUN = function(i){
      z <- i - m + 1
      z <- ifelse(z > 0, z, 1)
      w <- i + m + 1
      w <- ifelse(w < length(x), w, length(x))
      if(all(x[c(z : i, (i + 2) : w)] <= x[i + 1])) return(i + 1) else return(numeric(0))
    })
    pks <- unlist(pks)
    pks
  }
```

## Subplot Function 
```{r}
  ####
  # sub plot function
  sub_peakplot_fun <- function(x,window_size,highest_peaks_organised,peak_data) {
    point <- highest_peaks_organised[x,]
    plot_sub <- ggplot() +
      geom_line(data = peak_data[(point$idx - window_size):(point$idx + window_size),],
                aes(x = time, y = sim), 
                col = "orange") + 
      geom_line(data = peak_data[(point$idx - window_size):(point$idx + window_size),],
                aes(x = time, y = obs), 
                col = "steelblue") + 
      geom_point(data = point, aes(idx, peak_obs))
    return(plot_sub)
  }
```








